{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{{ file.title }} - غرفة الدراسة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Markdown rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">

    <style>
        :root {
            --sr-bg: #0f172a;
            --sr-surface: #1e293b;
            --sr-border: #334155;
            --sr-text: #e2e8f0;
            --sr-muted: #94a3b8;
            --sr-accent: #6366f1;
            --sr-accent-dark: #4f46e5;
            --sr-radius: 12px;
        }
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans Arabic', sans-serif; margin: 0; box-sizing: border-box; }
        body { background: var(--sr-bg); color: var(--sr-text); height: 100vh; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }

        /* === Toolbar === */
        .study-toolbar {
            height: 52px; background: var(--sr-surface); border-bottom: 1px solid var(--sr-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            flex-shrink: 0; gap: 8px;
        }
        .study-toolbar a, .study-toolbar button { color: var(--sr-muted); text-decoration: none; background: none; border: none; cursor: pointer; padding: 6px; border-radius: 8px; transition: all 0.15s; }
        .study-toolbar a:hover, .study-toolbar button:hover { color: #fff; background: rgba(255,255,255,0.08); }
        .toolbar-title { font-weight: 600; color: #fff; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px; }
        .toolbar-meta { color: var(--sr-muted); font-size: 0.75rem; }
        .progress-mini { height: 4px; background: var(--sr-border); border-radius: 2px; width: 80px; }
        .progress-mini .bar { height: 100%; background: var(--sr-accent); border-radius: 2px; transition: width 0.5s; }
        .toolbar-btn { display: inline-flex; align-items: center; gap: 4px; font-size: 0.8rem; padding: 6px 10px !important; border-radius: 8px !important; }

        /* === Split Container === */
        .study-container { display: flex; flex: 1; overflow: hidden; }

        /* === Content Viewer === */
        .content-viewer {
            flex: 1; background: var(--sr-bg); display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }
        .content-viewer iframe, .content-viewer video { flex: 1; width: 100%; border: none; background: #000; }
        .content-viewer .file-preview { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; text-align: center; }
        .content-viewer .file-preview i { font-size: 4rem; opacity: 0.3; margin-bottom: 16px; }
        .content-viewer .file-preview h5 { color: #fff; margin-bottom: 8px; }
        .content-viewer .file-preview .btn { margin-top: 16px; }

        /* Markdown viewer */
        .md-viewer { flex: 1; overflow-y: auto; padding: 24px; }
        .md-viewer .markdown-body { background: transparent; color: var(--sr-text); }
        .md-viewer .markdown-body h1, .md-viewer .markdown-body h2, .md-viewer .markdown-body h3 { color: #818cf8; border-color: var(--sr-border); }

        /* Image viewer */
        .image-viewer { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 16px; background: #000; }
        .image-viewer img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }

        /* === AI Panel Toggle Button (mobile) === */
        .ai-toggle-btn {
            display: none; position: fixed; bottom: 20px; left: 20px; z-index: 100;
            width: 56px; height: 56px; border-radius: 50%; background: var(--sr-accent);
            color: #fff; border: none; box-shadow: 0 4px 20px rgba(99,102,241,0.4);
            font-size: 1.4rem; cursor: pointer; transition: all 0.2s;
        }
        .ai-toggle-btn:active { transform: scale(0.9); }
        .ai-toggle-btn .badge { position: absolute; top: -4px; right: -4px; font-size: 0.6rem; }

        /* === AI Chat Panel === */
        .ai-panel {
            width: 380px; min-width: 320px; background: var(--sr-surface); display: flex;
            flex-direction: column; border-right: 1px solid var(--sr-border); transition: all 0.3s;
        }

        /* Panel Header */
        .ai-panel-header {
            padding: 12px 16px; border-bottom: 1px solid var(--sr-border);
            display: flex; flex-direction: column; gap: 8px; flex-shrink: 0;
        }
        .ai-panel-title { display: flex; justify-content: space-between; align-items: center; }
        .ai-panel-title h6 { margin: 0; font-size: 0.9rem; font-weight: 700; color: #fff; }
        .remaining-badge { font-size: 0.7rem; color: var(--sr-accent); padding: 4px 10px; background: rgba(99,102,241,0.15); border-radius: 20px; font-weight: 600; }

        /* Quick Actions */
        .quick-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .quick-action-btn {
            font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--sr-border);
            background: transparent; color: var(--sr-muted); cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        .quick-action-btn:hover { background: var(--sr-accent); color: #fff; border-color: var(--sr-accent); }

        /* Chat Area */
        .chat-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--sr-border); border-radius: 2px; }

        /* Chat Messages */
        .chat-msg { max-width: 90%; padding: 12px 16px; border-radius: 16px; font-size: 0.88rem; line-height: 1.7; word-break: break-word; animation: msgIn 0.25s ease; }
        .chat-msg.user { background: var(--sr-accent); color: #fff; align-self: flex-end; border-bottom-left-radius: 4px; }
        .chat-msg.bot { background: rgba(255,255,255,0.06); color: var(--sr-text); align-self: flex-start; border-bottom-right-radius: 4px; border: 1px solid var(--sr-border); }
        .chat-msg .chat-time { font-size: 0.6rem; opacity: 0.5; margin-top: 6px; display: block; }

        /* Markdown in bot messages */
        .chat-msg.bot h1, .chat-msg.bot h2, .chat-msg.bot h3, .chat-msg.bot h4 { color: #818cf8; margin-top: 12px; margin-bottom: 6px; font-size: 1rem; }
        .chat-msg.bot ul, .chat-msg.bot ol { padding-right: 20px; margin: 8px 0; }
        .chat-msg.bot li { margin-bottom: 4px; }
        .chat-msg.bot code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.82rem; }
        .chat-msg.bot pre { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .chat-msg.bot pre code { background: none; padding: 0; }
        .chat-msg.bot strong { color: #a5b4fc; }
        .chat-msg.bot table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 0.82rem; }
        .chat-msg.bot th, .chat-msg.bot td { border: 1px solid var(--sr-border); padding: 6px 8px; }
        .chat-msg.bot th { background: rgba(99,102,241,0.15); }

        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Welcome message */
        .chat-welcome { text-align: center; padding: 24px 16px; color: var(--sr-muted); }
        .chat-welcome i { font-size: 2.5rem; opacity: 0.3; display: block; margin-bottom: 12px; }
        .chat-welcome p { font-size: 0.82rem; margin: 4px 0; }

        /* Loading */
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; align-self: flex-start; }
        .typing-indicator span { width: 8px; height: 8px; background: var(--sr-muted); border-radius: 50%; animation: typingDot 1.2s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingDot { 0%, 60%, 100% { transform: translateY(0); opacity: 0.3; } 30% { transform: translateY(-6px); opacity: 1; } }

        /* Chat Input */
        .chat-input-area { padding: 12px; border-top: 1px solid var(--sr-border); flex-shrink: 0; }
        .chat-input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input-wrapper textarea {
            flex: 1; background: var(--sr-bg); border: 1px solid var(--sr-border); color: var(--sr-text);
            border-radius: 12px; padding: 10px 14px; font-size: 0.88rem; resize: none;
            min-height: 44px; max-height: 120px; line-height: 1.5; overflow-y: auto;
        }
        .chat-input-wrapper textarea:focus { outline: none; border-color: var(--sr-accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
        .chat-input-wrapper textarea::placeholder { color: var(--sr-muted); }
        .send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: var(--sr-accent); color: #fff;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 1.1rem; transition: all 0.15s;
        }
        .send-btn:hover { background: var(--sr-accent-dark); }
        .send-btn:active { transform: scale(0.9); }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Clear history */
        .clear-history-btn { font-size: 0.7rem; color: var(--sr-muted); background: none; border: none; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .clear-history-btn:hover { color: #ef4444; background: rgba(239,68,68,0.1); }

        /* === RESPONSIVE === */
        @media (max-width: 991px) {
            .ai-panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100% !important; min-width: 100%; z-index: 200; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1); }
            .ai-panel.show { transform: translateY(0); }
            .ai-toggle-btn { display: flex; align-items: center; justify-content: center; }
            .ai-panel-close { display: inline-flex !important; }
            .content-viewer { flex: 1; }
        }
        @media (min-width: 992px) {
            .ai-panel-close { display: none !important; }
        }
        @media (max-width: 576px) {
            .study-toolbar { padding: 0 10px; height: 48px; }
            .toolbar-title { max-width: 160px; font-size: 0.82rem; }
            .toolbar-actions .d-flex { gap: 2px !important; }
        }
    </style>
</head>
<body>
    <!-- === Toolbar === -->
    <div class="study-toolbar">
        <div class="d-flex align-items-center gap-2 min-w-0">
            <a href="{% url 'student:course_detail' course.pk %}" title="العودة للمقرر"><i class="bi bi-arrow-right fs-5"></i></a>
            <div class="min-w-0">
                <div class="toolbar-title">{{ file.title|truncatechars:45 }}</div>
                <div class="toolbar-meta">{{ course.course_code }}</div>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2 toolbar-actions">
            <div class="d-flex align-items-center gap-2 d-none d-sm-flex">
                <div class="progress-mini"><div class="bar" style="width:{{ progress.progress }}%"></div></div>
                <small class="text-muted" style="font-size:0.72rem;">{{ progress.progress }}%</small>
            </div>
            {% if prev_file %}<a href="{% url 'student:study_room' prev_file.pk %}" class="toolbar-btn" title="السابق"><i class="bi bi-chevron-right"></i></a>{% endif %}
            {% if next_file %}<a href="{% url 'student:study_room' next_file.pk %}" class="toolbar-btn" title="التالي"><i class="bi bi-chevron-left"></i></a>{% endif %}
            <a href="{% url 'courses:file_download' file.pk %}" class="toolbar-btn" title="تحميل"><i class="bi bi-download"></i></a>
        </div>
    </div>

    <!-- === Split View === -->
    <div class="study-container">
        <!-- Content Viewer -->
        <div class="content-viewer">
            {% if file.is_video %}
                <video controls autoplay>
                    <source src="{% url 'streaming:stream_file' file.pk %}" type="video/mp4">
                    متصفحك لا يدعم تشغيل الفيديو.
                </video>
            {% elif file.is_pdf %}
                <iframe src="{% url 'streaming:stream_file' file.pk %}#toolbar=1&navpanes=0&view=FitH" style="height:100%;"></iframe>
            {% elif file.is_image %}
                <div class="image-viewer">
                    <img src="{% url 'streaming:stream_file' file.pk %}" alt="{{ file.title }}">
                </div>
            {% elif file.content_type == 'external_link' %}
                {% if 'youtube.com' in file.external_link or 'youtu.be' in file.external_link %}
                    <iframe src="https://www.youtube.com/embed/{{ file.external_link|cut:'https://www.youtube.com/watch?v='|cut:'https://youtu.be/'|cut:'&'|truncatechars:11 }}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="height:100%;"></iframe>
                {% else %}
                    <iframe src="{{ file.external_link }}" style="height:100%;"></iframe>
                {% endif %}
            {% else %}
                <div class="file-preview">
                    <i class="bi {% if file.file_extension == '.docx' or file.file_extension == '.doc' %}bi-file-earmark-word{% elif file.file_extension == '.pptx' or file.file_extension == '.ppt' %}bi-file-earmark-ppt{% elif file.file_extension == '.xlsx' or file.file_extension == '.xls' %}bi-file-earmark-excel{% else %}bi-file-earmark{% endif %}"></i>
                    <h5>{{ file.title }}</h5>
                    <p style="color:var(--sr-muted);">نوع الملف: {{ file.file_extension|default:"غير معروف" }} | {{ file.file_size|filesizeformat }}</p>
                    <a href="{% url 'courses:file_download' file.pk %}" class="btn btn-primary"><i class="bi bi-download me-2"></i>تحميل الملف للعرض</a>
                </div>
            {% endif %}
        </div>

        <!-- AI Chat Panel -->
        <div class="ai-panel" id="aiPanel">
            <div class="ai-panel-header">
                <div class="ai-panel-title">
                    <h6><i class="bi bi-robot me-2"></i>مساعد الدراسة الذكي</h6>
                    <div class="d-flex align-items-center gap-2">
                        <span class="remaining-badge"><i class="bi bi-stars me-1"></i><span id="remainingCount">{{ remaining_requests }}</span></span>
                        <button class="clear-history-btn" onclick="clearHistory()" title="مسح المحادثة"><i class="bi bi-trash3"></i></button>
                        <button class="ai-panel-close toolbar-btn" onclick="toggleAIPanel()" style="display:none;" title="إغلاق"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="sendQuickAction('summarize')"><i class="bi bi-text-paragraph"></i>لخّص</button>
                    <button class="quick-action-btn" onclick="sendQuickAction('quiz')"><i class="bi bi-question-circle"></i>اختبرني</button>
                    <button class="quick-action-btn" onclick="sendQuickAction('explain')"><i class="bi bi-lightbulb"></i>اشرح</button>
                    <button class="quick-action-btn" onclick="sendQuickAction('keypoints')"><i class="bi bi-list-check"></i>نقاط رئيسية</button>
                    <button class="quick-action-btn" onclick="sendQuickAction('definitions')"><i class="bi bi-journal-text"></i>تعريفات</button>
                </div>
            </div>

            <div class="chat-area" id="chatArea">
                {% if existing_summary %}
                <div class="chat-msg bot">
                    <strong><i class="bi bi-file-text me-1"></i>ملخص سابق:</strong><br>
                    {{ existing_summary.summary_text|linebreaksbr|truncatechars:500 }}
                </div>
                {% endif %}
                {% if chat_history %}
                    {% for msg in chat_history %}
                    <div class="chat-msg user">{{ msg.question }}<div class="chat-time">{{ msg.created_at|date:"H:i" }}</div></div>
                    <div class="chat-msg bot">{{ msg.answer|linebreaksbr }}<div class="chat-time">{{ msg.created_at|date:"H:i" }}</div></div>
                    {% endfor %}
                {% else %}
                    {% if not existing_summary %}
                    <div class="chat-welcome">
                        <i class="bi bi-robot"></i>
                        <h6 style="color:#fff;">مرحباً! أنا مساعدك الذكي</h6>
                        <p>اسألني أي شيء عن محتوى "{{ file.title|truncatechars:30 }}"</p>
                        <p>أو استخدم الأزرار السريعة أعلاه للبدء</p>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" placeholder="اسأل عن المحتوى..." rows="1"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
                        oninput="autoResize(this)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="إرسال"><i class="bi bi-send"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile AI Toggle -->
    <button class="ai-toggle-btn" id="aiToggleBtn" onclick="toggleAIPanel()">
        <i class="bi bi-robot"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <script>
        const chatArea = document.getElementById('chatArea');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const csrfToken = '{{ csrf_token }}';
        const chatUrl = '{% url "student:ai_chat" file.pk %}';
        const clearUrl = '{% url "student:ai_chat_clear" file.pk %}';
        let isProcessing = false;

        // Configure marked for safe rendering
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true, gfm: true });
        }

        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        scrollToBottom();

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function renderMarkdown(text) {
            if (typeof marked !== 'undefined') {
                try { return marked.parse(text); } catch(e) {}
            }
            return text.replace(/\n/g, '<br>');
        }

        function addMessage(text, type) {
            // Remove welcome message
            const welcome = chatArea.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `chat-msg ${type}`;
            if (type === 'bot') {
                div.innerHTML = renderMarkdown(text);
            } else {
                div.textContent = text;
            }
            const timeEl = document.createElement('div');
            timeEl.className = 'chat-time';
            timeEl.textContent = new Date().toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
            div.appendChild(timeEl);
            chatArea.appendChild(div);
            scrollToBottom();
        }

        function showTyping() {
            const el = document.createElement('div');
            el.className = 'typing-indicator';
            el.id = 'typingIndicator';
            el.innerHTML = '<span></span><span></span><span></span>';
            chatArea.appendChild(el);
            scrollToBottom();
        }

        function hideTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function sendMessage() {
            const q = chatInput.value.trim();
            if (!q || isProcessing) return;
            addMessage(q, 'user');
            chatInput.value = '';
            chatInput.style.height = 'auto';
            doSend(q, 'ask');
        }

        function sendQuickAction(action) {
            if (isProcessing) return;
            const labels = {
                summarize: 'لخّص هذا المحتوى بالتفصيل',
                quiz: 'اختبرني بأسئلة متنوعة عن المحتوى',
                explain: 'اشرح المفاهيم الرئيسية بطريقة مبسطة',
                keypoints: 'استخرج النقاط الرئيسية في قائمة مرتبة',
                definitions: 'استخرج جميع التعريفات والمصطلحات المهمة'
            };
            addMessage(labels[action] || action, 'user');
            doSend('', action);
        }

        function doSend(question, action) {
            isProcessing = true;
            sendBtn.disabled = true;
            showTyping();

            const formData = new FormData();
            formData.append('question', question);
            formData.append('action', action);

            fetch(chatUrl, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken},
                body: formData,
            })
            .then(r => r.json())
            .then(data => {
                hideTyping();
                isProcessing = false;
                sendBtn.disabled = false;
                if (data.success) {
                    addMessage(data.answer, 'bot');
                    if (data.remaining !== undefined) {
                        document.getElementById('remainingCount').textContent = data.remaining;
                    }
                } else {
                    addMessage('⚠️ ' + (data.error || 'حدث خطأ، حاول مرة أخرى'), 'bot');
                }
            })
            .catch(() => {
                hideTyping();
                isProcessing = false;
                sendBtn.disabled = false;
                addMessage('⚠️ خطأ في الاتصال، تحقق من الإنترنت وحاول مرة أخرى', 'bot');
            });
        }

        function clearHistory() {
            if (!confirm('هل تريد مسح جميع المحادثات؟')) return;
            fetch(clearUrl, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken},
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    chatArea.innerHTML = `<div class="chat-welcome"><i class="bi bi-robot"></i><h6 style="color:#fff;">تم مسح المحادثة</h6><p>ابدأ محادثة جديدة!</p></div>`;
                }
            });
        }

        // Mobile AI Panel Toggle
        function toggleAIPanel() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('show');
            scrollToBottom();
        }

        // Update progress
        let progressTimer;
        function updateProgress() {
            clearTimeout(progressTimer);
            progressTimer = setTimeout(() => {
                fetch('{% url "student:update_progress" file.pk %}', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrfToken, 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/json'},
                    body: JSON.stringify({progress: Math.min(100, {{ progress.progress }} + 10)})
                }).catch(() => {});
            }, 30000);
        }
        updateProgress();
    </script>
</body>
</html>
