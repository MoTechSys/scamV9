{% extends 'layouts/dashboard_base.html' %}
{% block title %}تقاريري - S-ACM{% endblock %}
{% block page_title %}تقاريري وإحصائياتي{% endblock %}

{% block dashboard_content %}
<!-- Download Actions -->
<div class="d-flex gap-2 mb-3 flex-wrap">
    <button class="btn btn-outline-success btn-sm" onclick="window.print()">
        <i class="bi bi-printer me-1"></i>طباعة
    </button>
    <a href="?export=csv" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-file-earmark-excel me-1"></i>تصدير CSV
    </a>
</div>

<!-- Stats Overview -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card bg-gradient-primary">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.total_courses }}</div><div class="stat-label">المقررات</div></div>
                <i class="bi bi-book stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card bg-gradient-success">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.files_viewed }}</div><div class="stat-label">ملفات مستعرضة</div></div>
                <i class="bi bi-eye stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card bg-gradient-info">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.avg_progress }}%</div><div class="stat-label">متوسط التقدم</div></div>
                <i class="bi bi-graph-up stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card bg-gradient-warning">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.total_summaries }}</div><div class="stat-label">ملخصات AI</div></div>
                <i class="bi bi-file-text stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card bg-gradient-danger">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.total_questions }}</div><div class="stat-label">أسئلة AI</div></div>
                <i class="bi bi-question-circle stat-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
        <div class="stat-card" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
            <div class="d-flex justify-content-between align-items-start">
                <div><div class="stat-value">{{ stats.total_chats }}</div><div class="stat-label">محادثات AI</div></div>
                <i class="bi bi-chat-dots stat-icon"></i>
            </div>
        </div>
    </div>
</div>

<!-- Course Progress -->
<div class="card mb-4">
    <div class="card-header bg-transparent py-3">
        <h6 class="mb-0 fw-bold"><i class="bi bi-bar-chart me-2" style="color:var(--primary);"></i>تقدم المقررات</h6>
    </div>
    <div class="card-body p-0">
        {% for item in course_stats %}
        <div class="d-flex align-items-center gap-3 p-3" style="border-bottom:1px solid var(--border-color);">
            <div class="d-flex align-items-center justify-content-center flex-shrink-0" style="width:44px;height:44px;border-radius:12px;background:rgba(99,102,241,0.1);color:var(--primary);">
                <i class="bi bi-book fs-5"></i>
            </div>
            <div class="flex-grow-1 min-w-0">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0 fw-bold text-truncate" style="font-size:0.9rem;">{{ item.course.course_code }} - {{ item.course.course_name|truncatechars:30 }}</h6>
                    <span class="fw-bold flex-shrink-0 ms-2" style="color:var(--primary);font-size:0.85rem;">{{ item.progress }}%</span>
                </div>
                <div class="progress mb-1" style="height:6px;">
                    <div class="progress-bar bg-primary" style="width:{{ item.progress }}%"></div>
                </div>
                <small class="text-muted">{{ item.viewed_files }} من {{ item.total_files }} ملف</small>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-4"><i class="bi bi-book d-block mb-2" style="font-size:1.5rem;opacity:0.3;"></i>لا توجد مقررات مسجلة</div>
        {% endfor %}
    </div>
</div>

<!-- AI Usage History -->
<div class="card">
    <div class="card-header bg-transparent py-3">
        <h6 class="mb-0 fw-bold"><i class="bi bi-robot me-2" style="color:var(--primary);"></i>سجل استخدام الذكاء الاصطناعي</h6>
    </div>
    <div class="card-body p-0">
        {# Desktop table #}
        <div class="d-none d-md-block table-responsive">
            <table class="table table-hover mb-0">
                <thead><tr><th>التاريخ</th><th>النوع</th><th>الملف</th><th>الحالة</th></tr></thead>
                <tbody>
                {% for log in ai_history %}
                <tr>
                    <td><small>{{ log.request_time|date:"Y/m/d H:i" }}</small></td>
                    <td>
                        {% if log.request_type == 'summary' %}<span class="badge bg-primary-subtle text-primary">تلخيص</span>
                        {% elif log.request_type == 'questions' %}<span class="badge bg-warning-subtle text-warning">أسئلة</span>
                        {% else %}<span class="badge bg-info-subtle text-info">دردشة</span>{% endif %}
                    </td>
                    <td>{{ log.file.title|truncatechars:30|default:"-" }}<br><small class="text-muted">{{ log.file.course.course_code|default:"" }}</small></td>
                    <td>{% if log.success %}<span class="badge bg-success">نجح</span>{% else %}<span class="badge bg-danger">فشل</span>{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-4">لا توجد عمليات AI مسجلة</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {# Mobile cards #}
        <div class="d-block d-md-none">
            {% for log in ai_history %}
            <div class="p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="min-w-0">
                        <div class="fw-bold text-truncate" style="font-size:0.85rem;">{{ log.file.title|truncatechars:28|default:"-" }}</div>
                        <small class="text-muted">{{ log.request_time|date:"Y/m/d H:i" }}</small>
                    </div>
                    {% if log.request_type == 'summary' %}<span class="badge bg-primary-subtle text-primary">تلخيص</span>
                    {% elif log.request_type == 'questions' %}<span class="badge bg-warning-subtle text-warning">أسئلة</span>
                    {% else %}<span class="badge bg-info-subtle text-info">دردشة</span>{% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-4"><i class="bi bi-robot d-block mb-2" style="font-size:1.5rem;opacity:0.3;"></i>لا توجد عمليات AI</div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
