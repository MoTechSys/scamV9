{% extends 'layouts/dashboard_base.html' %}
{% block title %}التقارير والإحصائيات{% endblock %}
{% block page_title %}التقارير والإحصائيات{% endblock %}

{% block dashboard_content %}
{% if error %}
<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>{{ error }}</div>
{% else %}

<!-- Stats Overview Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card bg-gradient-primary">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_courses|default:0 }}</div>
                    <div class="stat-label">المقررات</div>
                </div>
                <div class="stat-icon"><i class="bi bi-book"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-gradient-success">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_files_viewed|default:0 }}</div>
                    <div class="stat-label">ملفات تم مشاهدتها</div>
                </div>
                <div class="stat-icon"><i class="bi bi-eye"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-gradient-info">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_ai_requests|default:0 }}</div>
                    <div class="stat-label">طلبات AI</div>
                </div>
                <div class="stat-icon"><i class="bi bi-robot"></i></div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-gradient-warning">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value">{{ total_files_completed|default:0 }}</div>
                    <div class="stat-label">ملفات مكتملة</div>
                </div>
                <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Activity -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-calendar-check me-2"></i>نشاط اليوم</div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <div class="fs-3 fw-bold text-primary">{{ today_views|default:0 }}</div>
                        <small class="text-muted">مشاهدات</small>
                    </div>
                    <div>
                        <div class="fs-3 fw-bold text-success">{{ today_ai|default:0 }}</div>
                        <small class="text-muted">طلبات AI</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-stars me-2"></i>تفاصيل استخدام AI</div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <div class="fs-4 fw-bold text-primary">{{ ai_by_type.summaries|default:0 }}</div>
                        <small class="text-muted">ملخصات</small>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold text-warning">{{ ai_by_type.questions|default:0 }}</div>
                        <small class="text-muted">أسئلة</small>
                    </div>
                    <div>
                        <div class="fs-4 fw-bold text-info">{{ ai_by_type.chats|default:0 }}</div>
                        <small class="text-muted">محادثات</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Progress -->
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-bar-chart-line me-2"></i>تقدم المقررات</div>
    <div class="card-body p-0">
        {% if course_stats %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr><th>المقرر</th><th>الملفات</th><th>المشاهدة</th><th>المكتملة</th><th>التقدم</th></tr>
                </thead>
                <tbody>
                {% for cs in course_stats %}
                <tr>
                    <td>
                        <a href="{% url 'student:course_detail' cs.course.pk %}" class="text-decoration-none fw-semibold">
                            {{ cs.course.course_code }}
                        </a>
                        <br><small class="text-muted">{{ cs.course.course_name|truncatechars:30 }}</small>
                    </td>
                    <td>{{ cs.total_files }}</td>
                    <td>{{ cs.viewed }}</td>
                    <td>{{ cs.completed }}</td>
                    <td style="min-width:120px;">
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height:8px;">
                                <div class="progress-bar {% if cs.progress == 100 %}bg-success{% elif cs.progress > 50 %}bg-primary{% else %}bg-warning{% endif %}"
                                     style="width:{{ cs.progress }}%"></div>
                            </div>
                            <small class="fw-bold">{{ cs.progress }}%</small>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state py-4">
            <i class="bi bi-book d-block"></i>
            <p>لا توجد مقررات مسجلة حالياً</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Activity Timeline -->
<div class="card">
    <div class="card-header"><i class="bi bi-clock-history me-2"></i>آخر النشاطات</div>
    <div class="card-body p-0">
        {% if recent_activities %}
        <div class="scrollable-list">
            {% for activity in recent_activities %}
            <div class="d-flex align-items-center gap-3 px-3 py-2" style="border-bottom:1px solid var(--border-light);">
                <div class="flex-shrink-0">
                    {% if activity.activity_type == 'view' %}
                    <span class="badge bg-primary-subtle text-primary rounded-circle p-2"><i class="bi bi-eye"></i></span>
                    {% elif activity.activity_type == 'download' %}
                    <span class="badge bg-success-subtle text-success rounded-circle p-2"><i class="bi bi-download"></i></span>
                    {% elif activity.activity_type == 'upload' %}
                    <span class="badge bg-info-subtle text-info rounded-circle p-2"><i class="bi bi-upload"></i></span>
                    {% else %}
                    <span class="badge bg-secondary-subtle text-secondary rounded-circle p-2"><i class="bi bi-activity"></i></span>
                    {% endif %}
                </div>
                <div class="flex-grow-1 min-w-0">
                    <div class="small text-truncate">{{ activity.description|default:"نشاط" }}</div>
                    <small class="text-muted">{{ activity.activity_time|timesince }} مضت</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state py-4">
            <i class="bi bi-clock d-block"></i>
            <p>لا توجد نشاطات مسجلة</p>
        </div>
        {% endif %}
    </div>
</div>

{% endif %}
{% endblock %}
